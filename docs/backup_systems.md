# Backup Systems

The backup systems are responsible for storing and verifying DICOM data. The primary backup system in this project is an Orthanc DICOM server, acting as a central archive.

## Orthanc

Orthanc is a lightweight DICOM server used here as the central archive for backed-up DICOM data. Interaction with this Orthanc server for backup and verification is performed using standard DICOM network communication protocols (C-MOVE, C-FIND, C-GET).

### Backup Process

The process of backing up data to the Orthanc server varies by data source:

*   **ARIA and MIM:** For data sources like ARIA and MIM, the application initiates a DICOM C-MOVE operation. This operation instructs the source system's DICOM node to send the specified DICOM instances directly to the Orthanc backup server.
*   **Mosaiq:** For Mosaiq, DICOM RT Record instances are first generated by the application. These generated instances are then sent using DICOM C-STORE to a designated staging SCP (Service Class Provider). This staging SCP is defined in the `dicom.toml` configuration file under the `[staging_scp_for_mosaiq]` section. Following a successful C-STORE to the staging area, a subsequent DICOM C-MOVE operation is initiated by the application to transfer these instances from the staging SCP to the main Orthanc backup server.

### Verification Process

Verification of data successfully backed up to the Orthanc server is performed as follows:

1.  **C-FIND:** A DICOM C-FIND request is sent to the Orthanc server to locate specific DICOM instances using their SOPInstanceUID. This confirms the existence of the instance on the backup server.
2.  **C-GET:** If the instance is found via C-FIND, a DICOM C-GET request is then sent to the Orthanc server to retrieve the actual DICOM file.
3.  **Comparison:** The retrieved DICOM data is then compared (e.g., byte-by-byte) with the original data to ensure data integrity.

### Configuration Note

For the backup and verification processes to function correctly:

*   The **Orthanc server** must be configured as a DICOM SCP. It needs to support:
    *   C-STORE SCP (to receive instances during C-MOVE operations initiated by other systems, and to respond to C-GET requests from this application).
    *   C-FIND SCP (to allow querying for instances).
    *   C-GET SCP (to allow retrieval of instances for verification).
    *   C-MOVE SCP (to receive instances from the staging SCP in the Mosaiq workflow).
    *   Its AE details (AETitle, IP address, Port number) must be correctly specified in the `[orthanc]` section of the `dicom.toml` configuration file.

*   For **Mosaiq workflows**, a **staging SCP** is required. Its AE details (AETitle, IP, Port) must be defined in the `[staging_scp_for_mosaiq]` section of `dicom.toml`. This staging SCP must support C-STORE SCP (to receive data from the Mosaiq generation process) and C-MOVE SCU (to respond to move requests from this application to the final Orthanc backup).

# Testing Strategy

The system includes a suite of unit and integration tests to ensure the reliability of its backup and verification functionalities.

### Mocking External Communications

DICOM network communications with external systems (source data systems, Orthanc backup, staging SCPs) are extensively mocked during unit testing using Python's `unittest.mock` library. This approach allows for isolated testing of:

*   **DICOM Utility Functions (`dicom_utils.py`):** Core SCU logic for C-FIND, C-MOVE, and C-GET operations is tested by mocking the underlying pynetdicom association and response handling.
*   **`Orthanc` Backup System (`src/backup_systems/orthanc.py`):** The interaction logic for the Orthanc backup system is tested by mocking the calls to `dicom_utils`. This includes verifying:
    *   Storage confirmation (existence check) using mocked C-FIND operations.
    *   Instance retrieval for verification using mocked C-GET operations.
*   **Data Source Modules (`src/data_sources/`):** The `transfer` methods of data source modules (ARIA, MIM, Mosaiq) are tested to ensure they correctly initiate C-MOVE operations to the backup destination or C-STORE operations to the staging SCP, as appropriate. This involves mocking the `transfer` methods of the source classes or the underlying DICOM calls they make.
*   **Main Backup Workflows (`src/cli/backup.py`):** The orchestration logic in `backup.py` is tested by mocking the data source methods, the Orthanc uploader methods, and DICOM utility calls to ensure the correct sequence of operations for each backup workflow.

### `MockDicomServer`

For some unit tests, particularly for data source modules like `ARIA` and `MIM` (`test_aria.py`, `test_mim.py`), a `MockDicomServer` (located in `src/tests/mock_dicom_server.py`) is utilized. This mock server simulates basic SCP behavior for C-FIND and C-MOVE protocol handshakes. It allows testing the SCU-side logic of these data source modules without requiring a live DICOM server, by responding to association requests and DIMSE messages in a controlled manner. For instance, it can be configured to return predefined C-FIND responses or acknowledge C-MOVE requests, and capture details like the `move_destination_aet` for assertion.

### Coverage

The testing strategy aims to provide good coverage of the new DICOM communication logic, error handling, and the different backup workflows implemented in the system. This helps ensure that changes to one part of the system do not inadvertently break other functionalities.
